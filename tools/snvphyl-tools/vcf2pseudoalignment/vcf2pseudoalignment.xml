<tool id="vcf2pseudoalignment" name="VCF 2 pseudoalignment" version ="0.0.18">
  <description>create a pseudo alignment from multiple VCFs files</description>
        <requirements>
                <requirement type="package" version="1.4.2">snvphyl</requirement>
                <requirement type="package" version="1.2">bcftools</requirement>
        </requirements>
  <stdio>
    	<exit_code range="1:" level="fatal" description="Unknown error has occurred"/>
  </stdio>
  <command>


        #for $f in $vcf_collection.keys#
        #set $name = str($vcf_collection[$f]).split('/')[-1]
         ln -s $vcf_collection[$f]  &amp;&amp; bcftools index $name  &amp;&amp;
        #end for#

        \$VCF2PSEUDO/vcf2pseudoalignment.pl

	-r "$reference"
	#if str($invalid) != 'None':
		--invalid-pos "$invalid"
	#end if
	-f fasta
	--numcpus \${GALAXY_SLOTS:-2}
	--fasta "$ref_fasta"

        #for $f in $vcf_collection.keys#
        #set $beer = $vcf_collection[$f]
        #set $path = str($beer).split('/')[-1]
        --consolidate_vcf "$path"
        #end for#

        #if $strain_list.select_list == "include":
              --include $strain_list.include
        #elif $strain_list.select_list == "exclude":
              --exclude $strain_list.exclude
        #end if

        ##mark where the output files will be sent to, simply have to match them up later in the xml output section
        -o pseudoalign

  </command>
  <inputs>
    <param name="reference" type="text"  label="Reference Name" value='reference' />
    <param name="ref_fasta" type="data"  label="Reference Fasta File" format="fasta"/>
    <param name="invalid" type="data"  label="Invalid position file" format="gff,bed" optional="true"/>
    <conditional name="strain_list">
      <param name="select_list" type="select" label="Strain Selecting options">
        <option value="all">Use all strains in collection</option>
        <option value="include">Provide list of subset of strains to only include</option>
        <option value="exclude">Provide list of subset of strains to exclude</option>
      </param>
      <when value="include">
        <param name="include" type="data"  label="List of strains to be include" format="text" optional="false"/>
      </when>
      <when value="exclude">
        <param name="exclude" type="data"  label="List of strains to be excluded" format="text" optional="false"/>
      </when>
    </conditional>
    <param name="vcf_collection" type="data_collection" label="Combined VCF Files" help="" optional="false" format="bcf_bgzip" collection_type="list" />
  </inputs>
  <outputs>
    <data format="tabular" name="positions" from_work_dir="pseudoalign-positions.tsv" />
    <data format="fasta" name="fasta" from_work_dir="pseudoalign.fasta"/>
    <data format="tabular" name="vcf2core" from_work_dir="pseudoalign-stats.csv" />
  </outputs>
  <tests>
    <test>
      <param name="reference" value="reference.fasta"/>
      <param name="ref_fasta" value="reference.fasta"/>
      <param name="invalid" value="invalid-positions.tsv"/>
      <param name="vcf_collection">
        <collection type="list">
          <element name="v1" value="v1.bcf.gz"/>
        </collection>
      </param>
      <output name="positions" file="expected.positions.tsv">
        <assert_contents>
          <has_text text="ref	2	valid	T	A	T"/>
          <has_text text="ref	4	filtered-invalid	C	T	C"/>
        </assert_contents>
      </output>
      <output name="core" file="expected_core.csv">
        <assert_contents>
          <has_text text="ref	4	1	3	3	100.00"/>
          <has_text text="all	4	1	3	3	100.00"/>
        </assert_contents>
      </output>
      <output name="fasta" file="expected.fasta">
        <assert_contents>
          <has_line_matching expression=">ref"/>
          <has_line_matching expression="T"/>
          <has_line_matching expression=">v1"/>
          <has_line_matching expression="A"/>
          <has_line_matching expression=">v2"/>
          <has_line_matching expression="T"/>
        </assert_contents>
      </output>
    </test>
  </tests>

  <help>
Best metaalignment program ever!
  </help>

</tool>
